---
// No props; global easter eggs: Konami code â†’ banner + WebAudio melody
---
<script>
  // @ts-nocheck
  // Global Easter Eggs Manager
  // Features: Konami Code -> Vocaloid Mode (Theme + Music)
  
  const LS_KEY = 'vocaloid-mode';
  const KONAMI_SEQ = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
  
  class EasterEggManager {
    constructor() {
      this.buffer = [];
      this.audioTrack = null;
      this.audioCtx = null;
      
      this.init();
    }

    init() {
      // Restore state
      if (localStorage.getItem(LS_KEY) === '1') {
        this.setMode(true, false); // Restore without notification/sound
      }

      // Key listener
      window.addEventListener('keydown', (e) => {
        const key = e.key.length === 1 ? e.key.toLowerCase() : e.key;
        this.buffer.push(key);
        if (this.buffer.length > KONAMI_SEQ.length) this.buffer.shift();
        
        if (this.checkKonami()) {
          this.toggleMode();
          this.buffer = []; // Reset buffer
        }
      });
    }

    checkKonami() {
      return KONAMI_SEQ.every((k, i) => this.buffer[i] === k);
    }

    getAudioContext() {
      if (!this.audioCtx) {
        const Ctor = window.AudioContext || window.webkitAudioContext;
        this.audioCtx = new Ctor();
      }
      return this.audioCtx;
    }

    ensureMusic() {
      if (this.audioTrack) return this.audioTrack;
      this.audioTrack = new Audio('/music/Anamanaguchi_Miku-Ft_Hatsune_Miku.mp3');
      this.audioTrack.volume = 0.4;
      this.audioTrack.loop = true;
      this.audioTrack.onerror = () => {
        // Fallback path if needed
        if (this.audioTrack) this.audioTrack.src = '/assets/Anamanaguchi_-_Miku_.mp3';
      };
      return this.audioTrack;
    }

    toggleMode() {
      const isActive = document.documentElement.classList.contains('vocaloid');
      this.setMode(!isActive, true);
    }

    setMode(enable, notify = true) {
      const root = document.documentElement;
      
      if (enable) {
        root.classList.add('vocaloid');
        localStorage.setItem(LS_KEY, '1');
        
        // Music
        const track = this.ensureMusic();
        track.currentTime = 0;
        track.play().catch(e => console.log('Autoplay blocked:', e));

        if (notify) {
          this.playOnSound();
          this.showToast('VOCALOID MODE: ACTIVATED', 'success');
        }
      } else {
        root.classList.remove('vocaloid');
        localStorage.removeItem(LS_KEY);
        
        // Stop Music
        if (this.audioTrack) {
          this.audioTrack.pause();
          this.audioTrack.currentTime = 0;
        }

        if (notify) {
          this.playOffSound();
          this.showToast('VOCALOID MODE: DEACTIVATED', 'neutral');
        }
      }
    }

    // UI: Toast Notification using Tailwind classes
    showToast(text, type = 'neutral') {
      const existing = document.getElementById('egg-toast');
      if (existing) existing.remove();

      const el = document.createElement('div');
      el.id = 'egg-toast';
      el.textContent = text;
      
      // Styles
      const baseClasses = "fixed bottom-8 right-8 px-6 py-3 rounded-xl backdrop-blur-md border shadow-2xl z-50 font-bold tracking-wider transition-all duration-500 transform translate-y-10 opacity-0";
      const typeClasses = type === 'success' 
        ? "bg-pink-500/20 border-pink-400/30 text-pink-200 shadow-pink-500/20"
        : "bg-slate-800/60 border-slate-600/30 text-slate-300 shadow-black/40";

      el.className = `${baseClasses} ${typeClasses}`;
      document.body.appendChild(el);

      // Animate in
      requestAnimationFrame(() => {
        el.classList.remove('translate-y-10', 'opacity-0');
      });

      // Remove after delay
      setTimeout(() => {
        el.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => el.remove(), 500);
      }, 3000);
    }

    // SFX: Activation Melody
    playOnSound() {
      try {
        const ctx = this.getAudioContext();
        const t = ctx.currentTime;
        
        // Happy Arpeggio
        const notes = [523.25, 659.25, 783.99, 1046.50]; // C E G C
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          
          osc.type = 'sine';
          osc.frequency.value = freq;
          
          gain.gain.setValueAtTime(0.05, t + i * 0.1);
          gain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.1 + 0.3);
          
          osc.connect(gain);
          gain.connect(ctx.destination);
          
          osc.start(t + i * 0.1);
          osc.stop(t + i * 0.1 + 0.3);
        });
      } catch (e) {}
    }

    // SFX: Deactivation Sound (Power Down)
    playOffSound() {
      try {
        const ctx = this.getAudioContext();
        const t = ctx.currentTime;
        
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.type = 'sawtooth'; // Buzzier sound
        osc.frequency.setValueAtTime(200, t);
        osc.frequency.exponentialRampToValueAtTime(50, t + 0.4); // Pitch drop
        
        gain.gain.setValueAtTime(0.05, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
        
        // Lowpass filter to dampen the sawtooth
        const filter = ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 1000;

        osc.connect(filter);
        filter.connect(gain);
        gain.connect(ctx.destination);
        
        osc.start(t);
        osc.stop(t + 0.4);
      } catch (e) {}
    }
  }

  // Initialize
  new EasterEggManager();
</script>