<style is:global>
  #bg-canvas { position: fixed; inset: 0; z-index: 0; display:block; width:100%; height:100%; }
  @media (prefers-reduced-motion: reduce){ #bg-canvas { display:none; } }
</style>
<canvas id="bg-canvas" aria-hidden="true"></canvas>
<script>
  // @ts-nocheck
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (!reduce) {
    const el = document.getElementById('bg-canvas');
    /** @type {HTMLCanvasElement | null} */
    const cvs = el instanceof HTMLCanvasElement ? el : null;
    if (!cvs) { /* no canvas */ }
    /** @type {CanvasRenderingContext2D | null} */
    const ctx = cvs?.getContext('2d');
    const DPR = Math.min(window.devicePixelRatio || 1, 2);

    let W = 0, H = 0, T = 0;
    let last = 0;

    function isVocaloid() {
      try { return localStorage.getItem('vocaloidMode') === 'on'; } catch { return false; }
    }
    
    function getPalette() {
      const v = isVocaloid();
      return {
        bg: v ? ['#1a0b2e', '#2d1b4e'] : ['#05070a', '#0b1021'],
        nebula: v 
          ? ['rgba(255,105,180,0.12)', 'rgba(0,255,209,0.1)', 'rgba(82,113,255,0.08)'] 
          : ['rgba(124,58,237,0.15)', 'rgba(56,189,248,0.12)', 'rgba(16,185,129,0.08)'],
        star: v ? '255,200,255' : '220,240,255',
        link: v ? 'rgba(255,114,228,' : 'rgba(100,200,255,'
      };
    }

    let pmx = 0, pmy = 0;
    let mx = 0, my = 0;
    window.addEventListener('pointermove', (e) => {
      pmx = (e.clientX / window.innerWidth) * 2 - 1;
      pmy = (e.clientY / window.innerHeight) * 2 - 1;
    }, { passive: true });

    const STAR_COUNT = 200;
    let stars = [];
    
    let shootingStar = {
      active: false,
      x: 0, y: 0,
      dx: 0, dy: 0,
      len: 0,
      speed: 0,
      life: 0
    };

    function resetStars() {
      stars = Array.from({ length: STAR_COUNT }, () => ({
        x: Math.random(),
        y: Math.random(),
        z: Math.random(),
        size: Math.random(),
        tw: Math.random() * 2 + 0.5,
        ph: Math.random() * Math.PI * 2
      }));
    }

    function spawnShootingStar() {
      if (Math.random() > 0.005 || shootingStar.active) return;
      shootingStar = {
        active: true,
        x: Math.random() * W * 0.8 + W * 0.1,
        y: Math.random() * H * 0.5,
        dx: -Math.random() * 4 - 2,
        dy: Math.random() * 2 + 1,
        len: Math.random() * 80 + 40,
        speed: Math.random() * 10 + 15,
        life: 1.0
      };
    }

    const NEBULA = [
      { x: 0.2, y: 0.3, r: 0.4, s: 0.00005, p: 0 },
      { x: 0.8, y: 0.7, r: 0.5, s: -0.00004, p: 1 },
      { x: 0.5, y: 0.5, r: 0.6, s: 0.00003, p: 2 }
    ];

    function resize() {
      if (!cvs) return;
      W = cvs.width = Math.floor(window.innerWidth * DPR);
      H = cvs.height = Math.floor(window.innerHeight * DPR);
      cvs.style.width = window.innerWidth + 'px';
      cvs.style.height = window.innerHeight + 'px';
      resetStars();
    }

    function drawBackground(pal) {
      const g = ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, pal.bg[0]);
      g.addColorStop(1, pal.bg[1]);
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);
    }

    function drawNebula(pal) {
      ctx.save();
      ctx.globalCompositeOperation = 'screen'; 
      ctx.filter = `blur(${40 * DPR}px)`;
      
      NEBULA.forEach((n, i) => {
        const col = pal.nebula[i % pal.nebula.length];
        const t = T * n.s;
        const cx = W * (n.x + Math.cos(t) * 0.1) + mx * 40 * DPR;
        const cy = H * (n.y + Math.sin(t) * 0.1) + my * 40 * DPR;
        const r = Math.min(W, H) * n.r;
        
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);
        g.addColorStop(0, col);
        g.addColorStop(1, 'transparent');
        
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.restore();
    }

    function drawStars(pal) {
      ctx.save();
      ctx.globalCompositeOperation = 'lighter';
      
      stars.forEach(s => {
        const px = (s.x * W) + mx * (30 * s.z) * DPR;
        const py = (s.y * H) + my * (30 * s.z) * DPR;
        
        const alpha = 0.3 + 0.7 * Math.abs(Math.sin(T * 0.001 * s.tw + s.ph));
        const size = (0.5 + s.size * 1.5) * DPR * (1 - s.z * 0.5);
        
        ctx.fillStyle = `rgba(${pal.star}, ${alpha})`;
        ctx.beginPath();
        ctx.arc(px, py, size, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.restore();
    }

    function drawConstellations(pal) {
      ctx.save();
      ctx.lineWidth = 0.5 * DPR;
      ctx.globalCompositeOperation = 'lighter';
      for (let i = 0; i < stars.length; i += 2) {
        const s1 = stars[i];
        const x1 = (s1.x * W) + mx * (30 * s1.z) * DPR;
        const y1 = (s1.y * H) + my * (30 * s1.z) * DPR;
        
        for (let j = i + 1; j < stars.length; j++) {
          const s2 = stars[j];
          const dx = (s2.x * W + mx * 30 * s2.z * DPR) - x1;
          const dy = (s2.y * H + my * 30 * s2.z * DPR) - y1;
          const dist = dx*dx + dy*dy;
          
          if (dist < 8000 * DPR * DPR) {
            const alpha = (1 - dist / (8000 * DPR * DPR)) * 0.15;
            ctx.strokeStyle = pal.link + alpha + ')';
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x1 + dx, y1 + dy);
            ctx.stroke();
          }
        }
      }
      ctx.restore();
    }

    function drawShootingStar() {
      if (!shootingStar.active) return;
      
      ctx.save();
      ctx.lineWidth = 2 * DPR;
      ctx.lineCap = 'round';
      
      const grad = ctx.createLinearGradient(
        shootingStar.x, shootingStar.y, 
        shootingStar.x + shootingStar.len, shootingStar.y - shootingStar.len
      );
      grad.addColorStop(0, 'rgba(255,255,255,1)');
      grad.addColorStop(1, 'rgba(255,255,255,0)');
      
      ctx.strokeStyle = grad;
      ctx.beginPath();
      ctx.moveTo(shootingStar.x, shootingStar.y);
      ctx.lineTo(shootingStar.x - shootingStar.dx * 4, shootingStar.y - shootingStar.dy * 4);
      ctx.stroke();

      shootingStar.x += shootingStar.dx;
      shootingStar.y += shootingStar.dy;
      shootingStar.life -= 0.02;
      
      if (shootingStar.x < -100 || shootingStar.y > H + 100 || shootingStar.life <= 0) {
        shootingStar.active = false;
      }
      ctx.restore();
    }

    function loop() {
      const now = performance.now();
      if (!last) last = now;
      const dt = now - last;
      last = now;
      T += dt;

      mx += (pmx - mx) * 0.05;
      my += (pmy - my) * 0.05;

      if (ctx) {
        const pal = getPalette();
        drawBackground(pal);
        drawNebula(pal);
        drawConstellations(pal);
        drawStars(pal);
        
        spawnShootingStar();
        drawShootingStar();
      }
      
      requestAnimationFrame(loop);
    }

    window.addEventListener('resize', resize);
    resize();
    requestAnimationFrame(loop);
  }
</script>